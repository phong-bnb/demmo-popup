<!DOCTYPE html>
<html>
  <head>
    <title>ExtJS Demo - Clean Version</title>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/ext-all.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/resources/css/ext-all.css"
    />
  </head>
  <body>
    <script>
      // T·∫Øt warnings kh√¥ng c·∫ßn thi·∫øt
      if (console && console.warn) {
        var originalWarn = console.warn;
        console.warn = function (message) {
          if (
            message &&
            message.toString().indexOf("Permissions policy violation") === -1
          ) {
            originalWarn.apply(console, arguments);
          }
        };
      }

      // Define all classes inline for stable execution

      // 1. Popup ViewController
      Ext.define("MyApp.view.HoSo.Popup.Popup_ViewController", {
        extend: "Ext.app.ViewController",
        alias: "controller.Popup_ViewController",

        handleLuuThongTin: function (btn) {
          const formPanel = btn.up("window").down("form");
          if (formPanel.isValid()) {
            const values = formPanel.getValues();
            btn.up("window").fireEvent("save", values);
          }
          btn.up("window").close();
        },

        onClose: function (btn) {
          btn.up("window").close();
        },
      });

      // 2. Popup View
      Ext.define("MyApp.view.HoSo.Popup.Popup_View", {
        extend: "Ext.window.Window",
        xtype: "Popup_View",
        controller: "Popup_ViewController",
        title: "Th√¥ng tin m·ªü t·∫≠p",
        width: 600,
        height: 400,
        layout: "fit",
        modal: true,

        initComponent: function () {
          var me = this;
          me.items = [
            {
              xtype: "form",
              padding: 10,
              layout: "vbox",
              defaults: {
                xtype: "textfield",
                labelWidth: 100,
                width: "100%",
                margin: "0 0 10 0",
              },
              items: [
                { fieldLabel: "Ng√†y m·ªü t·∫≠p", name: "ngayMoTap" },
                { fieldLabel: "Ph·∫ßn", name: "phan" },
                { fieldLabel: "T·∫≠p s·ªë", name: "tap" },
                { fieldLabel: "Tr·∫°ng th√°i", name: "trangthai" },
              ],
            },
          ];

          me.dockedItems = [
            {
              xtype: "toolbar",
              dock: "bottom",
              items: [
                {
                  text: "L∆∞u",
                  itemId: "btnLuu",
                  handler: "handleLuuThongTin",
                },
                {
                  text: "ƒê√≥ng",
                  itemId: "btnDong",
                  handler: "onClose",
                },
              ],
            },
          ];

          me.callParent(arguments);
        },
      });

      // 3. Main View Controller
      Ext.define("MyApp.view.HoSo.ThemTapPopup_ViewController", {
        extend: "Ext.app.ViewController",
        alias: "controller.ThemTapPopup_ViewController",

        onOpenPopup: function () {
          var me = this;
          var popup = Ext.create("MyApp.view.HoSo.Popup.Popup_View");

          popup.on(
            "save",
            function (values) {
              me.getView().addDataToTable(values);
            },
            me
          );

          popup.show();
        },
      });

      // 4. Main View
      Ext.define("MyApp.view.HoSo.ThemTapPopup_View", {
        extend: "Ext.panel.Panel",
        xtype: "ThemTapPopup_View",
        controller: "ThemTapPopup_ViewController",

        layout: "fit",
        title: "Qu·∫£n l√Ω th√¥ng tin",

        initComponent: function () {
          var me = this;
          me.dataStore = Ext.create("Ext.data.Store", {
            fields: ["ngayMoTap", "phan", "tap", "trangthai"],
            data: [],
          });

          me.items = [
            {
              xtype: "grid",
              reference: "dataGrid",
              title: "Danh s√°ch d·ªØ li·ªáu",
              store: me.dataStore,
              columns: [
                { text: "Ng√†y m·ªü t·∫≠p", dataIndex: "ngayMoTap", flex: 1 },
                { text: "Ph·∫ßn", dataIndex: "phan", flex: 1 },
                { text: "T·∫≠p s·ªë", dataIndex: "tap", flex: 1 },
                { text: "Tr·∫°ng th√°i", dataIndex: "trangthai", flex: 2 },
              ],
              tbar: [
                {
                  text: "Th√™m m·ªõi",
                  itemId: "openPopupButton",
                  handler: "onOpenPopup",
                },
              ],
            },
          ];

          me.callParent(arguments);
        },

        // Method ƒë·ªÉ th√™m d·ªØ li·ªáu v√†o table
        addDataToTable: function (data) {
          this.dataStore.add(data);
          console.log("‚úÖ Data added to table:", data);
        },
      });

      // Start Application
      Ext.onReady(function () {
        console.log("üöÄ ExtJS App Starting...");

        // T·∫°o v√† hi·ªÉn th·ªã main view
        var mainView = Ext.create("MyApp.view.HoSo.ThemTapPopup_View", {
          renderTo: Ext.getBody(),
          width: "100%",
          height: 600,
        });

        console.log("‚úÖ Main view created successfully!");
      });
    </script>
  </body>
</html>
