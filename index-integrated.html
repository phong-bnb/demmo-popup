<!DOCTYPE html>
<html>
  <head>
    <title>ExtJS Demo - All Classes Integrated</title>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/ext-all.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/resources/css/ext-all.css"
    />
  </head>
  <body>
    <script>
      // Define all classes inline for stable execution

      // 1. Popup ViewController
      Ext.define("MyApp.view.HoSo.Popup.Popup_ViewController", {
        extend: "Ext.app.ViewController",
        alias: "controller.Popup_ViewController",

        handleLuuThongTin: function (btn) {
          const formPanel = btn.up("window").down("form");
          if (formPanel.isValid()) {
            const values = formPanel.getValues();
            btn.up("window").fireEvent("save", values);
          }
          btn.up("window").close();
        },

        onClose: function (btn) {
          btn.up("window").close();
        },
      });

      // 2. Popup View
      Ext.define("MyApp.view.HoSo.Popup.Popup_View", {
        extend: "Ext.window.Window",
        xtype: "Popup_View",
        controller: "Popup_ViewController",
        title: "Thông tin mở tập",
        width: 600,
        height: 400,
        layout: "fit",
        modal: true,

        initComponent: function () {
          var me = this;
          me.items = [
            {
              xtype: "form",
              padding: 10,
              layout: "vbox",
              defaults: {
                xtype: "textfield",
                labelWidth: 100,
                width: "100%",
                margin: "0 0 10 0",
              },
              items: [
                { fieldLabel: "Ngày mở tập", name: "ngayMoTap" },
                { fieldLabel: "Phần", name: "phan" },
                { fieldLabel: "Tập số", name: "tap" },
                { fieldLabel: "Trạng thái", name: "trangthai" },
              ],
            },
          ];

          me.dockedItems = [
            {
              xtype: "toolbar",
              dock: "bottom",
              items: [
                {
                  text: "Lưu",
                  itemId: "btnLuu",
                  handler: "handleLuuThongTin",
                },
                {
                  text: "Đóng",
                  itemId: "btnDong",
                  handler: "onClose",
                },
              ],
            },
          ];

          me.callParent(arguments);
        },
      });

      // 3. Main View Controller
      Ext.define("MyApp.view.HoSo.ThemTapPopup_ViewController", {
        extend: "Ext.app.ViewController",
        alias: "controller.ThemTapPopup_ViewController",

        onOpenPopup: function () {
          var me = this;
          var popup = Ext.create("MyApp.view.HoSo.Popup.Popup_View");

          popup.on(
            "save",
            function (values) {
              me.getView().addDataToTable(values);
            },
            me
          );

          popup.show();
        },
      });

      // 4. Main View
      Ext.define("MyApp.view.HoSo.ThemTapPopup_View", {
        extend: "Ext.form.Panel",
        xtype: "ThemTapPopup_View",
        controller: "ThemTapPopup_ViewController",

        layout: "vbox",
        scrollable: true,
        padding: 5,
        title: "Quản lý thông tin",
        width: 800,
        height: 600,

        initComponent: function () {
          var me = this;
          me.dataStore = Ext.create("Ext.data.Store", {
            fields: ["ngayMoTap", "phan", "tap", "trangthai"],
            data: [],
          });

          me.items = [
            {
              xtype: "grid",
              reference: "dataGrid",
              title: "Danh sách dữ liệu",
              flex: 1,
              width: "100%",
              store: me.dataStore,
              columns: [
                { text: "Ngày mở tập", dataIndex: "ngayMoTap", flex: 1 },
                { text: "Phần", dataIndex: "phan", flex: 1 },
                { text: "Tập số", dataIndex: "tap", flex: 1 },
                { text: "Trạng thái", dataIndex: "trangthai", flex: 2 },
              ],
              tbar: [
                {
                  text: "Thêm mới",
                  iconCls: "x-fa fa-plus",
                  itemId: "openPopupButton",
                  handler: "onOpenPopup",
                },
              ],
            },
          ];

          me.callParent(arguments);
        },

        // Method để thêm dữ liệu vào table
        addDataToTable: function (data) {
          this.dataStore.add(data);
          console.log("Data added to table:", data);
        },
      });

      // 5. Main Controller
      Ext.define("MyApp.controller.MainController", {
        extend: "Ext.app.Controller",
        views: ["HoSo.ThemTapPopup_View"],

        init: function () {
          this.control({
            "ThemTapPopup_View #openPopupButton": {
              click: this.onOpenPopup,
            },
            Popup_View: {
              save: this.onDataSaved,
            },
          });
        },

        onOpenPopup: function () {
          const popup = Ext.create("MyApp.view.HoSo.Popup.Popup_View");
          popup.on("save", this.onDataSaved, this);
          popup.show();
        },

        onDataSaved: function (values) {
          const grid = Ext.ComponentQuery.query("ThemTapPopup_View")[0];
          if (grid && grid.addDataToTable) {
            grid.addDataToTable(values);
          }
        },
      });

      // Start Application
      Ext.onReady(function () {
        console.log("ExtJS App Starting with All Classes...");

        // Tạo application
        Ext.create("Ext.app.Application", {
          name: "MyApp",
          controllers: ["MainController"],

          launch: function () {
            console.log("Application launched");

            // Tạo và hiển thị main view
            var mainView = Ext.create("MyApp.view.HoSo.ThemTapPopup_View", {
              renderTo: Ext.getBody(),
              width: "100%",
              height: 600,
            });

            console.log("Main view created and rendered");
          },
        });
      });
    </script>
  </body>
</html>
